# Kubernetes для пользователей

Бесплатный курс на Stepic [Kubernetes для пользователей](https://stepik.org/course/99188/syllabus).

## Docker

### Как уменьшить размер образа?
Одним из самых простых шагов по оптимизации контейнерных развертываний Docker является использование меньших базовых образов. **Alpine** – это легкий дистрибутив Linux, разработанный для обеспечения безопасности и эффективности использования ресурсов.

### Как уменьшить время сборки образа?
Dockerfile имеет луковую архитектуру, и каждый слой накладывается на следующий. Слои создают команды FROM, RUN, COPY, и ADD. Если вышестоящий слой изменяется, то нижележащие будут **пересобираться** (кэш на нижних работать не будет). Именно поэтому то, что меняется реже всего записывается в Dockerfile как можно **выше**.

## K8S

### Как взаимодействовать с K8S?
С помощью kubectl мы можем взаимодействовать с ресурсами K8S **двумя** способами.

* Императивно - указывать сделать, что мы хотим.

* Декларативно - описать в yaml-манифесте, что мы хотим и просить сделать.

Всегда разворачиваете приложения **декларативно**!

Команды kubectl:
* create
* apply
* edit 
* get

> Если вы столкнетесь с какими-либо проблемами в работе Подов, используйте `describe` - одной из первых команд в debug'е проблемы.

### Namespace
Namespace позволяют нам разградить Поды разных приложений или разных команд. Вы можете представлять Под, как файлик, а Namespace с Подами как папку. Одна команда имеет доступ к папке и файлам внутри, другая - нет. 

Чтобы декларативно создать пространство имен, пишем manifest-file:

```yaml
apiVersion: v1
kind: Namespace
metadata:
  name: new-namespace
```

Применяем манифест в K8S - `kubectl apply -f namespace.yaml`.
Проверяем, что создали namespace - `kubectl get ns`.

### Service
* ClusterIP
    * Обеспечивает сервис **внутри кластера** - внешнего доступа нет.
    * Недостаток: выбор этого сервиса делает Под доступным только изнутри кластера, т.е. есть риск потерять внешний IP адрес при переезде Пода.
* LoadBalancer
    * Позволяет открыть внешний доступ и жестко привязать внешний IP адрес к Поду (например, можно поднять реплику БД со статичным IP адресом).
    *  Недостаток: ограниченность IPv4 адресов.
* NodePort
    * Открывает на всех Нодах кластера порт, запросы попадающие на этот порт будут перенаправлены в ваш Под.
    * Недостаток: порты доступны в интервале 30000–32767.

### Контроллеры
* Deployment, на самом деле это контроллер контроллера ReplicaSet, который отслеживает количество реплик, контроллер Деплоймент расширяет этот функционал.
* DaemonSet
* Job
* CronJob

### Хранение данных в K8S
* ConfigMaps
* Secrets
* EmptyDir - данный том предназначен для хранения небольших данных, он создается пустым (отсюда и название) на сервере, где лежит Под в оперативной памяти или на диске. EmptyDir будет существовать, пока будет жив его Под. 
* Persistent Volume Claim