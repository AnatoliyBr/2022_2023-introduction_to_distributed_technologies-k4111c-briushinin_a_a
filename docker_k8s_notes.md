# Kubernetes для пользователей

Бесплатный курс на Stepic [Kubernetes для пользователей](https://stepik.org/course/99188/syllabus).

---
## Docker

### Как уменьшить размер образа? - MultiStage сборка образов
Одним из самых простых шагов по оптимизации контейнерных развертываний Docker является использование **меньших базовых образов** и **MultiStage сборка** - создание временного и финального образа на базе легковесного Alpine. **Alpine** – это легкий дистрибутив Linux, разработанный для обеспечения безопасности и эффективности использования ресурсов.

### Как уменьшить время сборки образа?
Dockerfile имеет луковую архитектуру, и каждый слой накладывается на следующий. Слои создают команды FROM, RUN, COPY, и ADD. Если вышестоящий слой изменяется, то нижележащие будут **пересобираться** (кэш на нижних работать не будет). Именно поэтому то, что меняется реже всего записывается в Dockerfile как можно **выше**.

### Docker best practice
* MultiStage сборка образов
* Минимизация количества слоев
* Расположение статичных слоев как можно выше

---
## Kubernetes (K8S)

### Как взаимодействовать с K8S?
С помощью kubectl мы можем взаимодействовать с ресурсами K8S **двумя** способами.

* Императивно - указывать сделать, что мы хотим.

* Декларативно - описать в yaml-манифесте, что мы хотим и просить сделать.

Всегда разворачиваете приложения **декларативно**!

### Команды kubectl
* Смена кластеров  
    * config
* Создание, изменение, удаление объектов  
    * create
    * apply
    * edit
    * delete
* Просмотр информации об объектах
    * get
    * describe
    * logs
    * top
* Проброс портов
    * port-forward
* Работа с версиями развертывания
    * rollout

> Если вы столкнетесь с какими-либо проблемами в работе Подов, используйте `describe` - одной из первых команд в debug'е проблемы.

### Namespace
Namespaces позволяют нам разградить Поды разных приложений или разных команд. Вы можете представлять Под, как файлик, а Namespace с Подами как папку. Одна команда имеет доступ к папке и файлам внутри, другая - нет. 

Чтобы декларативно создать пространство имен, пишем manifest-file:

```yaml
apiVersion: v1
kind: Namespace
metadata:
  name: new-namespace
```

Применяем манифест в K8S - `kubectl apply -f namespace.yaml`.
Проверяем, что создали namespace - `kubectl get ns`.

### Service
* ClusterIP
    * Обеспечивает сервис **внутри кластера** - внешнего доступа нет
    * Недостаток: выбор этого сервиса делает Под доступным только изнутри кластера, т.е. есть риск потерять внешний IP адрес при переезде Pod
* LoadBalancer
    * Позволяет открыть внешний доступ и жестко привязать внешний IP адрес к Pod (например, можно поднять реплику БД со статичным IP адресом)
    *  Недостаток: ограниченность IPv4 адресов
* NodePort
    * Открывает на всех Нодах кластера порт, запросы попадающие на этот порт будут перенаправлены в ваш Pod
    * Недостаток: порты доступны в интервале 30000–32767

### Controller
* Deployment
    * на самом деле это контроллер контроллера ReplicaSet, который отслеживает количество реплик, контроллер Деплоймент расширяет этот функционал
* DaemonSet
    *  поддерживает по одной реплике Pod на каждой из Node кластера
* Job
    * поднимает Pod, отрабатывает и помирает до следующего запуска
* CronJob
    * Job, который запускается по расписанию

### Хранение данных в K8S
* ConfigMaps
    * хранение конфигурационных данных
    * объем данных не может превышать 1 Мб 
* Secrets
    * хранение конфиденциальных данных
    * данные кодируется в base64
* EmptyDir
    * данный том предназначен для хранения небольших данных
    * создается пустым (отсюда и название) на сервере, где лежит Pod в оперативной памяти или на диске
    * существует, пока будет жив его Pod
* Persistent Volume Claim
    * Данный тип ресурса позволяет хранить персистентные данные ваших приложений.
    * Для того, чтобы использовать PVC, Вам необходимо, чтобы в кластере был реализован интерфейс CSI (Container Storage Interface) администратором кластера
    * PVC своего рода запрос необходимого постоянного тома (диска)

### Helm